#!/usr/bin/env node

// ============================================================================
// –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –î–õ–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –° GOOGLE GEMINI API
// ============================================================================
// –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Google Gemini –¥–ª—è Hive Mind.
// Gemini –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–∞—Ä—è–¥—É —Å Claude –∏ OpenCode.
//
// –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Gemini:
// - 2M —Ç–æ–∫–µ–Ω–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Å—å –±–æ–ª—å—à–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)
// - Context Caching (–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–¥–∏–Ω —Ä–∞–∑, –¥–µ—à—ë–≤—ã–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã)
// - Gemini Flash ‚Äî –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π –∏ –¥–µ—à—ë–≤—ã–π –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á
// - Native Function Calling ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –∞–≥–µ–Ω—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
// ============================================================================

// ----------------------------------------------------------------------------
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ò–ú–ü–û–†–¢–´
// ----------------------------------------------------------------------------

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ globalThis.use (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ solve.mjs)
if (typeof globalThis.use === 'undefined') {
  globalThis.use = (await eval(await (await fetch('https://unpkg.com/use-m/use.js')).text())).use;
}

// –ò–º–ø–æ—Ä—Ç Google Generative AI SDK
import { GoogleGenerativeAI } from "@google/generative-ai";

// –ò–º–ø–æ—Ä—Ç —É—Ç–∏–ª–∏—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –∏ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏
const { $ } = await use('command-stream');
const fs = (await use('fs')).promises;
const path = (await use('path')).default;
const { exec } = await use('child_process');
const { promisify } = await use('util');
const execAsync = promisify(exec);

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –æ–±—â–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import { log } from './lib.mjs';
import { reportError } from './sentry.lib.mjs';
import { timeouts } from './config.lib.mjs';

// ----------------------------------------------------------------------------
// –î–û–°–¢–£–ü–ù–´–ï –ú–û–î–ï–õ–ò GEMINI
// ----------------------------------------------------------------------------
// –ú–∞–ø–ø–∏–Ω–≥ –∞–ª–∏–∞—Å–æ–≤ –º–æ–¥–µ–ª–µ–π –Ω–∞ –∏—Ö –ø–æ–ª–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤ Google AI Studio.
// –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–º–µ–Ω–∞ –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ:
// --model flash –≤–º–µ—Å—Ç–æ --model gemini-1.5-flash
export const availableModels = {
  'gemini-flash': 'gemini-1.5-flash',  // –ë—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à—ë–≤–∞—è –º–æ–¥–µ–ª—å
  'gemini-pro': 'gemini-1.5-pro',      // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –º–æ–¥–µ–ª—å —Å 2M –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  'flash': 'gemini-1.5-flash',         // –ö–æ—Ä–æ—Ç–∫–∏–π –∞–ª–∏–∞—Å –¥–ª—è flash
  'pro': 'gemini-1.5-pro',             // –ö–æ—Ä–æ—Ç–∫–∏–π –∞–ª–∏–∞—Å –¥–ª—è pro
};

/**
 * –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–ï –ê–õ–ò–ê–°–ê –ú–û–î–ï–õ–ò –í –ü–û–õ–ù–´–ô ID
 * =========================================
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —É–¥–æ–±–Ω—ã–π –∞–ª–∏–∞—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'flash') –≤ –ø–æ–ª–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
 * –º–æ–¥–µ–ª–∏ –¥–ª—è Google AI API (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'gemini-1.5-flash').
 *
 * @param {string} model - –ê–ª–∏–∞—Å –∏–ª–∏ –ø–æ–ª–Ω–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏
 * @returns {string} –ü–æ–ª–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–æ–¥–µ–ª–∏
 */
export const mapModelToId = (model) => {
  return availableModels[model] || model;
};

// ----------------------------------------------------------------------------
// –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í (TOOLS) –î–õ–Ø FUNCTION CALLING
// ----------------------------------------------------------------------------
// Gemini –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Function Calling –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –≤–Ω–µ—à–Ω–∏–º –º–∏—Ä–æ–º.
// –ú—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ AI –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –¥–ª—è:
// - –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è shell-–∫–æ–º–∞–Ω–¥ (git, npm, —Ç–µ—Å—Ç—ã)
// - –ß—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–æ–≤
// - –ù–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
// - –ó–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã

const toolsDefinition = [
  {
    functionDeclarations: [
      // ----------------------------------------------------------------
      // –ò–ù–°–¢–†–£–ú–ï–ù–¢: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Shell-–∫–æ–º–∞–Ω–¥
      // ----------------------------------------------------------------
      // –ü–æ–∑–≤–æ–ª—è–µ—Ç AI –≤—ã–ø–æ–ª–Ω—è—Ç—å bash-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º:
      // git, npm install, –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤, –∫–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —Ç.–¥.
      {
        name: "execute_shell",
        description: "–í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É bash. –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è git –æ–ø–µ—Ä–∞—Ü–∏–π, —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤.",
        parameters: {
          type: "OBJECT",
          properties: {
            command: {
              type: "STRING",
              description: "Bash-–∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 'git status', 'npm test')"
            }
          },
          required: ["command"]
        }
      },

      // ----------------------------------------------------------------
      // –ò–ù–°–¢–†–£–ú–ï–ù–¢: –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
      // ----------------------------------------------------------------
      // –ü–æ–∑–≤–æ–ª—è–µ—Ç AI —á–∏—Ç–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
      {
        name: "read_file",
        description: "–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.",
        parameters: {
          type: "OBJECT",
          properties: {
            path: {
              type: "STRING",
              description: "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: 'src/index.js')"
            }
          },
          required: ["path"]
        }
      },

      // ----------------------------------------------------------------
      // –ò–ù–°–¢–†–£–ú–ï–ù–¢: –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª
      // ----------------------------------------------------------------
      // –ü–æ–∑–≤–æ–ª—è–µ—Ç AI —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ñ–∞–π–ª—ã
      {
        name: "write_file",
        description: "–ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —Ñ–∞–π–ª (–ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π). –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.",
        parameters: {
          type: "OBJECT",
          properties: {
            path: {
              type: "STRING",
              description: "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É"
            },
            content: {
              type: "STRING",
              description: "–ü–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏"
            }
          },
          required: ["path", "content"]
        }
      },

      // ----------------------------------------------------------------
      // –ò–ù–°–¢–†–£–ú–ï–ù–¢: –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
      // ----------------------------------------------------------------
      // –ü–æ–∑–≤–æ–ª—è–µ—Ç AI –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
      {
        name: "list_directory",
        description: "–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.",
        parameters: {
          type: "OBJECT",
          properties: {
            path: {
              type: "STRING",
              description: "–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
            }
          },
          required: ["path"]
        }
      },

      // ----------------------------------------------------------------
      // –ò–ù–°–¢–†–£–ú–ï–ù–¢: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
      // ----------------------------------------------------------------
      // AI –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç–æ –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –µ—Å–ª–∏ –∑–∞—Å—Ç—Ä—è–ª
      {
        name: "task_completed",
        description: "–í—ã–∑–æ–≤–∏ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –µ—Å–ª–∏ —Ç—ã –∑–∞—Å—Ç—Ä—è–ª –∏ –Ω–µ –º–æ–∂–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.",
        parameters: {
          type: "OBJECT",
          properties: {
            summary: {
              type: "STRING",
              description: "–ò—Ç–æ–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–∞–±–æ—Ç—ã"
            },
            success: {
              type: "BOOLEAN",
              description: "true –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ, false –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å"
            }
          },
          required: ["summary", "success"]
        }
      }
    ]
  }
];

// ----------------------------------------------------------------------------
// –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í
// ----------------------------------------------------------------------------
// –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ–≥–¥–∞ AI –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

/**
 * –í–´–ü–û–õ–ù–ï–ù–ò–ï SHELL-–ö–û–ú–ê–ù–î–´
 * =========================
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç bash-–∫–æ–º–∞–Ω–¥—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (stdout, stderr, exit code).
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AI –¥–ª—è git –æ–ø–µ—Ä–∞—Ü–∏–π, —Å–±–æ—Ä–∫–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç.–¥.
 *
 * @param {string} command - –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
 * @returns {Promise<string>} –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å exit code –∏ –≤—ã–≤–æ–¥–æ–º
 */
async function executeShell(command) {
  try {
    const { stdout, stderr } = await execAsync(command, {
      maxBuffer: 5 * 1024 * 1024  // 5MB –±—É—Ñ–µ—Ä –¥–ª—è –±–æ–ª—å—à–∏—Ö –≤—ã–≤–æ–¥–æ–≤
    });

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return `EXIT CODE: 0\nSTDOUT:\n${stdout.slice(0, 5000)}\nSTDERR:\n${stderr.slice(0, 5000)}`;
  } catch (e) {
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    return `EXIT CODE: ${e.code || 1}\nERROR:\n${e.message}\nSTDERR:\n${e.stderr ? e.stderr.slice(0, 5000) : ''}`;
  }
}

/**
 * –ß–¢–ï–ù–ò–ï –§–ê–ô–õ–ê
 * =============
 * –ß–∏—Ç–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
 *
 * @param {string} filePath - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É
 * @returns {Promise<string>} –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
 */
async function readFile(filePath) {
  try {
    return await fs.readFile(path.resolve(filePath), "utf-8");
  } catch (e) {
    return `Error reading file: ${e.message}`;
  }
}

/**
 * –ó–ê–ü–ò–°–¨ –í –§–ê–ô–õ
 * ==============
 * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —Ñ–∞–π–ª, —Å–æ–∑–¥–∞–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
 *
 * @param {string} filePath - –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É
 * @param {string} content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
 * @returns {Promise<string>} –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
 */
async function writeFile(filePath, content) {
  try {
    const p = path.resolve(filePath);
    // –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
    await fs.mkdir(path.dirname(p), { recursive: true });
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª
    await fs.writeFile(p, content, "utf-8");
    return "File written successfully.";
  } catch (e) {
    return `Error writing file: ${e.message}`;
  }
}

/**
 * –°–ü–ò–°–û–ö –§–ê–ô–õ–û–í –í –î–ò–†–ï–ö–¢–û–†–ò–ò
 * ===========================
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
 *
 * @param {string} dirPath - –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
 * @returns {Promise<string>} –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (–ø–æ—Å—Ç—Ä–æ—á–Ω–æ) –∏–ª–∏ –æ—à–∏–±–∫–∞
 */
async function listDirectory(dirPath) {
  try {
    const files = await fs.readdir(path.resolve(dirPath));
    return files.join("\n");
  } catch (e) {
    return `Error listing directory: ${e.message}`;
  }
}

// ----------------------------------------------------------------------------
// –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö GEMINI API
// ----------------------------------------------------------------------------

/**
 * –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò GEMINI API
 * =================================
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ:
 * 1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω GEMINI_API_KEY –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
 * 2. API –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã
 *
 * –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã —á—Ç–æ–±—ã —Ä–∞–Ω–æ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.
 *
 * @returns {Promise<boolean>} true –µ—Å–ª–∏ Gemini –¥–æ—Å—Ç—É–ø–µ–Ω, false –µ—Å–ª–∏ –Ω–µ—Ç
 */
export async function validateGeminiConnection() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
    if (!process.env.GEMINI_API_KEY) {
      await log("‚ùå GEMINI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è", { level: 'error' });
      return false;
    }

    await log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Gemini API...');

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç
    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    await model.generateContent("Hello");

    await log("‚úÖ Gemini API –ø–æ–¥–∫–ª—é—á—ë–Ω —É—Å–ø–µ—à–Ω–æ");
    return true;
  } catch (e) {
    await log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Gemini: ${e.message}`, { level: 'error' });
    reportError(e, {
      context: 'gemini_connection_validation',
      apiKeyPresent: !!process.env.GEMINI_API_KEY
    });
    return false;
  }
}

// ----------------------------------------------------------------------------
// –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø –ó–ê–î–ê–ß –ß–ï–†–ï–ó GEMINI
// ----------------------------------------------------------------------------

/**
 * –í–´–ü–û–õ–ù–ï–ù–ò–ï –ö–û–ú–ê–ù–î–´ –ß–ï–†–ï–ó GEMINI
 * =================================
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ—à–µ–Ω–∏—è GitHub Issues —Å –ø–æ–º–æ—â—å—é Gemini.
 *
 * –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:
 * 1. –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–º–ø—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∑–∞–¥–∞—á–∏ (issue)
 * 2. –ó–∞–ø—É—Å–∫–∞–µ—Ç AI –≤ —Ü–∏–∫–ª–µ —Å function calling
 * 3. AI –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (read_file, execute_shell, etc.)
 * 4. –ú—ã –≤—ã–ø–æ–ª–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã AI
 * 5. AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Ä–µ—à–∞–µ—Ç —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ
 * 6. –¶–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø–æ–∫–∞ AI –Ω–µ –≤—ã–∑–æ–≤–µ—Ç task_completed
 *
 * @param {string} prompt - –ü—Ä–æ–º–ø—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∑–∞–¥–∞—á–∏ (–æ–±—ã—á–Ω–æ GitHub Issue)
 * @param {Object} options - –û–ø—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
 * @param {string} [options.model='gemini-flash'] - –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
 * @param {string} [options.agent='coder'] - –¢–∏–ø –∞–≥–µ–Ω—Ç–∞ (coder, lawyer, etc.)
 * @param {string} [options.law] - –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
 * @param {number} [options.maxIterations=30] - –ú–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π agent loop
 * @returns {Promise<Object>} –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
 */
export async function executeGeminiCommand(prompt, options = {}) {
  const modelName = mapModelToId(options.model || "gemini-flash");
  const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

  // --------------------------------------------------------------------
  // –í–´–ë–û–† –°–ò–°–¢–ï–ú–ù–û–ì–û –ü–†–û–ú–ü–¢–ê –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –¢–ò–ü–ê –ê–ì–ï–ù–¢–ê
  // --------------------------------------------------------------------
  let systemInstruction = `–¢—ã ‚Äî –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π AI software engineer.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –±–∞–≥–∏, –ø–∏—Å–∞—Ç—å –∫–æ–¥ –∏ —Ä–µ—à–∞—Ç—å GitHub Issues.

–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:
1. –ò—Å—Å–ª–µ–¥—É–π –∫–æ–¥–æ–≤—É—é –±–∞–∑—É (list_directory, read_file)
2. –ü—Ä–æ—á–∏—Ç–∞–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
3. –°–æ–∑–¥–∞–π –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è
4. –†–µ–∞–ª–∏–∑—É–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –∏—Ö
5. –í—ã–∑–æ–≤–∏ task_completed –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å`;

  // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
  // (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è TTO - –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ–º–ø–ª–∞–µ–Ω—Å–∞)
  if (options.agent === 'lawyer') {
    const lawPrompts = {
      civil: `–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –∫–æ–¥–µ–∫—Å –†–§. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å—Ç–∞—Ç—å–∏ –ì–ö –†–§.`,
      labor: `–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –¢—Ä—É–¥–æ–≤–æ–π –∫–æ–¥–µ–∫—Å –†–§. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å—Ç–∞—Ç—å–∏ –¢–ö –†–§.`,
      tax: `–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–¥–µ–∫—Å –†–§. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å—Ç–∞—Ç—å–∏ –ù–ö –†–§.`,
      corporate: `–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ (–§–ó "–û–± –û–û–û", –§–ó "–û–± –ê–û").`,
      chile: `Especializaci√≥n: Leyes de Chile (Ley 21.459, Ley 19.628, Ley 21.663).`,
      default: `–û–±—â–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è.`
    };

    const lawType = options.law || 'default';
    systemInstruction = `–¢—ã ‚Äî —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π AI-–∞–≥–µ–Ω—Ç.
${lawPrompts[lawType] || lawPrompts.default}

–ó–∞–¥–∞—á–∏:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç—ã
- –í—ã—è–≤–ª—è–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
- –¶–∏—Ç–∏—Ä—É–π —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–≤ —Å –Ω–æ–º–µ—Ä–∞–º–∏
- –ù–ï –∏–∑–º–µ–Ω—è–π –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –∫–æ–¥, —Ç–æ–ª—å–∫–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (.md, .txt)
- –§–æ—Ä–º–∏—Ä—É–π –æ—Ç—á—ë—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown`;
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
  const model = genAI.getGenerativeModel({
    model: modelName,
    systemInstruction: { parts: [{ text: systemInstruction }] },
    tools: toolsDefinition
  });

  // –ó–∞–ø—É—Å–∫–∞–µ–º —á–∞—Ç-—Å–µ—Å—Å–∏—é
  const chat = model.startChat({ history: [] });

  const MAX_ITERATIONS = options.maxIterations || 30;
  let iteration = 0;
  let toolUseCount = 0;

  try {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø—Ä–æ–º–ø—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∑–∞–¥–∞—á–∏)
    let result = await chat.sendMessage(prompt);

    // --------------------------------------------------------------------
    // AGENT LOOP: –¶–∏–∫–ª –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è AI —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
    // --------------------------------------------------------------------
    while (iteration < MAX_ITERATIONS) {
      iteration++;
      const response = result.response;
      const functionCalls = response.functionCalls();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–∑–≤–∞–ª –ª–∏ AI –∫–∞–∫–∏–µ-—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
      if (functionCalls && functionCalls.length > 0) {
        toolUseCount += functionCalls.length;
        const functionResponses = [];

        // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –≤—ã–∑–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
        for (const call of functionCalls) {
          const { name, args } = call;
          let output = "";

          // –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ–º –≤—ã–∑–æ–≤ –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
          if (name === "execute_shell") {
            output = await executeShell(args.command);
          } else if (name === "read_file") {
            output = await readFile(args.path);
          } else if (name === "write_file") {
            output = await writeFile(args.path, args.content);
          } else if (name === "list_directory") {
            output = await listDirectory(args.path);
          } else if (name === "task_completed") {
            // AI —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã
            return {
              success: args.success,
              output: args.summary,
              sessionId: `gemini-${Date.now()}`,
              limitReached: false,
              limitResetTime: null,
              messageCount: iteration,
              toolUseCount: toolUseCount
            };
          }

          // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ AI
          functionResponses.push({
            functionResponse: {
              name,
              response: { content: output }
            }
          });
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ AI
        result = await chat.sendMessage(functionResponses);

      } else {
        // AI –Ω–µ –≤—ã–∑–≤–∞–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª —Ç–µ–∫—Å—Ç
        const text = response.text();

        // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –µ—Å–ª–∏ AI –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –∏—Ç–µ—Ä–∞—Ü–∏–π
        if (text.includes("Task completed") || iteration > 25) {
          return {
            success: true,
            output: text,
            sessionId: `gemini-${Date.now()}`,
            limitReached: false,
            messageCount: iteration,
            toolUseCount: toolUseCount
          };
        }

        // –ü–æ–¥—Ç–∞–ª–∫–∏–≤–∞–µ–º AI –∫ –¥–µ–π—Å—Ç–≤–∏—é
        result = await chat.sendMessage("–ü—Ä–æ–¥–æ–ª–∂–∞–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –≤—ã–∑–æ–≤–∏ task_completed –µ—Å–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª.");
      }
    }

    // –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π
    return {
      success: false,
      output: "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π agent loop.",
      limitReached: false,
      messageCount: iteration,
      toolUseCount: toolUseCount
    };

  } catch (error) {
    // --------------------------------------------------------------------
    // –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –ò –õ–ò–ú–ò–¢–û–í API
    // --------------------------------------------------------------------

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏ rate limit
    if (error.message.includes("429") || error.message.includes("Resource has been exhausted")) {
      await log("‚ö†Ô∏è Gemini API Rate Limit –¥–æ—Å—Ç–∏–≥–Ω—É—Ç", { level: 'warn' });

      return {
        success: false,
        output: "Gemini API Rate Limit Reached",
        limitReached: true,
        limitResetTime: Date.now() + 60 * 1000,  // –ß–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        messageCount: iteration,
        toolUseCount: toolUseCount
      };
    }

    // –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
    await log(`‚ùå –û—à–∏–±–∫–∞ Gemini: ${error.message}`, { level: 'error' });
    reportError(error, {
      context: 'gemini_execution',
      model: modelName,
      iteration,
      toolUseCount
    });

    return {
      success: false,
      output: `Gemini Error: ${error.message}`,
      limitReached: false,
      messageCount: iteration,
      toolUseCount: toolUseCount
    };
  }
}

// ----------------------------------------------------------------------------
// –≠–ö–°–ü–û–†–¢ –ú–û–î–£–õ–Ø
// ----------------------------------------------------------------------------

export default {
  validateGeminiConnection,
  executeGeminiCommand,
  availableModels,
  mapModelToId
};
